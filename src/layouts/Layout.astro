---
import '../styles/global.css';
import ThemeToggle from '../components/ThemeToggle.astro';
import LanguageToggle from '../components/LanguageToggle.astro';

interface Props {
  title: string;
  description?: string;
  canonicalUrl?: string;
  ogImage?: string;
  type?: 'website' | 'article';
}

const { 
  title, 
  description = "Portafolio de ebooks y cursos de programación de Diego Saavedra",
  canonicalUrl,
  ogImage = '/og-image.png',
  type = 'website'
} = Astro.props;

const siteUrl = 'https://statick88.github.io/ebooks';
const fullCanonicalUrl = canonicalUrl || siteUrl;
const fullOgImage = ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={fullCanonicalUrl} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={fullCanonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={fullOgImage} />
    <meta property="og:locale" content="es_ES" />
    <meta property="og:locale:alternate" content="en_US" />
    <meta property="og:site_name" content="Ebooks Portfolio - Diego Saavedra" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={fullCanonicalUrl} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={fullOgImage} />
    <meta name="twitter:creator" content="@statick_ds" />
    
    <!-- Theme -->
    <meta name="theme-color" content="#4c80cc" />
    <meta name="color-scheme" content="light dark" />
    
    <!-- Author -->
    <meta name="author" content="Diego Medardo Saavedra García" />
    <meta name="keywords" content="ebooks, cursos, programación, Python, Django, React, JavaScript, TypeScript, Docker, Linux, educacion, desarrollo web" />
    
    <!-- Robots -->
    <meta name="robots" content="index, follow" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Ebooks Portfolio - Diego Saavedra",
      "url": siteUrl,
      "description": description,
      "author": {
        "@type": "Person",
        "name": "Diego Medardo Saavedra García",
        "url": "https://statick88.github.io"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": `${siteUrl}/?search={search_term_string}`,
        "query-input": "required name=search_term_string"
      }
    })} />
    
    <!-- Initialize theme before render to prevent flash -->
    <script is:inline>
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
    
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    </script>

    <!-- Initialize language before render -->
    <script is:inline>
      const lang = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('lang')) {
          return localStorage.getItem('lang');
        }
        return 'es';
      })();
    
      document.documentElement.setAttribute('lang', lang);
    </script>
  </head>
  <body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">Ir al contenido principal</a>
    
    <slot />
    <LanguageToggle />
    <ThemeToggle />

    <!-- Centralized i18n system -->
    <script is:inline>
      // Complete translations object
      window.i18n = {
        translations: {
          es: {
            hero: {
              title: "Portafolio de Ebooks",
              subtitle: "Cursos y materiales educativos creados a lo largo de mi carrera como desarrollador y educador."
            },
            filters: {
              search: "Buscar ebooks...",
              filterBy: "Filtrar por:",
              category: "Categoría",
              level: "Nivel",
              allCategories: "Todas las categorías",
              allLevels: "Todos los niveles",
              clear: "Limpiar",
              clearFilters: "Limpiar filtros"
            },
            sort: {
              sortBy: "Ordenar por:",
              yearDesc: "Más reciente",
              yearAsc: "Más antiguo",
              nameAsc: "Nombre A-Z",
              nameDesc: "Nombre Z-A",
              starsDesc: "Más populares"
            },
            results: {
              single: "ebook encontrado",
              plural: "ebooks encontrados",
              noResults: "No se encontraron ebooks con los filtros actuales"
            },
            card: {
              viewEbook: "Ver Ebook",
              code: "Código",
              published: "Publicado",
              stars: "estrellas"
            },
            detail: {
              backToPortfolio: "Volver al portafolio",
              viewOnline: "Ver Ebook Online",
              viewCode: "Ver Código en GitHub",
              publishedOn: "Publicado en GitHub Pages",
              lastUpdated: "Última actualización",
              relatedEbooks: "Ebooks relacionados",
              noRelated: "No hay ebooks relacionados"
            },
            categories: {
              Backend: "Backend",
              Frontend: "Frontend",
              DevOps: "DevOps",
              Mobile: "Mobile",
              Data: "Data Science",
              Other: "Otros"
            },
            levels: {
              Básico: "Básico",
              Intermedio: "Intermedio",
              Avanzado: "Avanzado"
            },
            footer: {
              createdBy: "Creado por"
            },
            notFound: {
              title: "Página no encontrada",
              description: "La página que buscas no existe o ha sido movida.",
              backHome: "Volver al inicio"
            }
          },
          en: {
            hero: {
              title: "Ebooks Portfolio",
              subtitle: "Courses and educational materials created throughout my career as a developer and educator."
            },
            filters: {
              search: "Search ebooks...",
              filterBy: "Filter by:",
              category: "Category",
              level: "Level",
              allCategories: "All categories",
              allLevels: "All levels",
              clear: "Clear",
              clearFilters: "Clear filters"
            },
            sort: {
              sortBy: "Sort by:",
              yearDesc: "Newest first",
              yearAsc: "Oldest first",
              nameAsc: "Name A-Z",
              nameDesc: "Name Z-A",
              starsDesc: "Most popular"
            },
            results: {
              single: "ebook found",
              plural: "ebooks found",
              noResults: "No ebooks found with current filters"
            },
            card: {
              viewEbook: "View Ebook",
              code: "Code",
              published: "Published",
              stars: "stars"
            },
            detail: {
              backToPortfolio: "Back to portfolio",
              viewOnline: "View Ebook Online",
              viewCode: "View Code on GitHub",
              publishedOn: "Published on GitHub Pages",
              lastUpdated: "Last updated",
              relatedEbooks: "Related ebooks",
              noRelated: "No related ebooks"
            },
            categories: {
              Backend: "Backend",
              Frontend: "Frontend",
              DevOps: "DevOps",
              Mobile: "Mobile",
              Data: "Data Science",
              Other: "Other"
            },
            levels: {
              Básico: "Beginner",
              Intermedio: "Intermediate",
              Avanzado: "Advanced"
            },
            footer: {
              createdBy: "Created by"
            },
            notFound: {
              title: "Page not found",
              description: "The page you're looking for doesn't exist or has been moved.",
              backHome: "Back to home"
            }
          }
        },

        // Get nested value from object using dot notation
        getNestedValue(obj, path) {
          if (!obj || !path) return undefined;
          return path.split('.').reduce((current, key) => {
            if (current && typeof current === 'object' && key in current) {
              return current[key];
            }
            return undefined;
          }, obj);
        },

        // Get translation by key
        t(key, lang) {
          const currentLang = lang || document.documentElement.getAttribute('lang') || 'es';
          const translations = this.translations[currentLang] || this.translations.es;
          return this.getNestedValue(translations, key) || key;
        },

        // Update all elements with data-i18n attribute
        updateContent(lang) {
          const t = this.translations[lang];
          if (!t) return;
          
          // Update text content
          document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (!key) return;
            
            const value = this.getNestedValue(t, key);
            
            if (value !== undefined) {
              if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = value;
              } else {
                el.textContent = value;
              }
            }
          });

          // Update placeholders
          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (!key) return;
            const value = this.getNestedValue(t, key);
            if (value !== undefined) {
              el.placeholder = value;
            }
          });

          // Update aria-labels
          document.querySelectorAll('[data-i18n-aria]').forEach(el => {
            const key = el.getAttribute('data-i18n-aria');
            if (!key) return;
            const value = this.getNestedValue(t, key);
            if (value !== undefined) {
              el.setAttribute('aria-label', value);
            }
          });

          // Update title if exists
          document.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            if (!key) return;
            const value = this.getNestedValue(t, key);
            const suffix = el.getAttribute('data-i18n-title-suffix');
            if (value !== undefined) {
              el.setAttribute('title', suffix ? `${value}: ${suffix}` : value);
            }
          });
        },

        // Initialize i18n system
        init() {
          const lang = document.documentElement.getAttribute('lang') || 'es';
          
          const doUpdate = () => {
            try {
              this.updateContent(lang);
            } catch (e) {
              console.error('i18n updateContent error:', e.message);
            }
          };
          
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', doUpdate, { once: true });
          } else {
            requestAnimationFrame(() => {
              requestAnimationFrame(doUpdate);
            });
          }

          // Listen for language changes
          window.addEventListener('langchange', (event) => {
            try {
              this.updateContent(event.detail.lang);
            } catch (e) {
              console.error('i18n langchange error:', e.message);
            }
          });
        }
      };

      // Auto-initialize
      window.i18n.init();
    </script>
  </body>
</html>

<style is:global>
  :root {
    --color-bg: #fff;
    --color-bg-hover: #f4f4f4;
    --color-bg-card: #fafafa;
    --color-text: #000;
    --color-text-secondary: #444;
    --color-text-muted: #666;
    --color-border: #ddd;
    --color-accent: #4c80cc;
    --color-accent-hover: #3a6bb3;
    --color-success: #1a7f37;
    --color-github: #24292e;
    --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
    --radius-sm: 5px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --transition: all 0.2s ease;
  }

  html.dark {
    --color-bg: #0a0e1a;
    --color-bg-hover: #1b243d;
    --color-bg-card: #121829;
    --color-text: #ffffff;
    --color-text-secondary: #b8b8b8;
    --color-text-muted: #888;
    --color-border: #2a2a2a;
    --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
  }

  html {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--color-bg);
    color: var(--color-text);
    letter-spacing: -0.025rem;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  body,
  figure {
    margin: 0;
    padding: 0;
  }

  a {
    text-decoration: none;
  }

  ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  h1,
  h2,
  h3,
  h4 {
    margin: 0;
    color: var(--color-text);
    font-weight: 600;
    letter-spacing: -0.02em;
  }

  p {
    color: var(--color-text-secondary);
    font-size: 0.95rem;
    line-height: 1.6;
    margin: 0;
    text-wrap: pretty;
  }

  code,
  .mono {
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.9em;
    background: var(--color-bg-hover);
    padding: 0.1em 0.3em;
    border-radius: 3px;
  }

  /* Skip link for accessibility */
  .skip-link {
    position: absolute;
    top: -100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-accent);
    color: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    font-weight: 500;
    z-index: 99999;
    transition: top 0.2s ease;
  }

  .skip-link:focus {
    top: 1rem;
    outline: none;
    box-shadow: var(--shadow-lg);
  }

  @media print {
    :root {
      --color-bg: #fff !important;
      --color-text: #000 !important;
      --color-text-secondary: #555 !important;
    }
    
    html {
      background: #fff !important;
      color: #000 !important;
    }
    
    .skip-link,
    #lang-toggle,
    #theme-toggle {
      display: none !important;
    }
  }
</style>
